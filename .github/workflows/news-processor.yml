name: Scheduled News Processing
# Auto news processing workflow

on:
  schedule:
    # Run at 7:40, 7:50, 8:00 PM Iran time (16:10, 16:20, 16:30 UTC)
    - cron: '10 16 * * *'  # 7:40 PM Iran
    - cron: '20 16 * * *'  # 7:50 PM Iran  
    - cron: '30 16 * * *'  # 8:00 PM Iran
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write  # Required to push changes back to repo

jobs:
  process-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        persist-credentials: true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Generate .env file from secrets
      run: |
        cat > .env << EOF
        SITES=${{ vars.SITES }}
        SITES_FILE=${{ vars.SITES_FILE }}
        TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
        OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
        OPENROUTER_API_URL=${{ vars.OPENROUTER_API_URL }}
        AI_MODEL=${{ vars.AI_MODEL }}
        AI_FILTER_SELECT_PROMPT=${{ vars.AI_FILTER_SELECT_PROMPT }}
        AI_PROCESS_PROMPT=${{ vars.AI_PROCESS_PROMPT }}
        RATE_SITE_DELAY=${{ vars.RATE_SITE_DELAY }}
        SIMILARITY_THRESHOLD=${{ vars.SIMILARITY_THRESHOLD }}
        EOF
    
    - name: Configure git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Run news processor
      run: python main.py
    
    - name: Clean up
      run: rm -f .env